module.exports = {
    config: {
        name: "autorename", // ржХржорж╛ржирзНржбрзЗрж░ ржирж╛ржо
        version: "1.0.0",
        credits: "SAIM", // ржлрж╛ржЗрж▓ржЯрж┐ ржЖржорж╛рж░ рждрзИрж░рж┐ ржХрж░рж╛
        hasPermssion: 0,
        commandCategory: "Group",
        usages: "On/Off",
        cooldowns: 5
    },

    // ------------------------------------------------
    // Configuration Setup
    // ------------------------------------------------
    // ржПржЗ ржоржбрж┐ржЙрж▓ржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ ржЗржнрзЗржирзНржЯрзЗрж░ ржЙржкрж░ ржХрж╛ржЬ ржХрж░ржмрзЗ, ржХрзЛржирзЛ ржХржорж╛ржирзНржбрзЗрж░ ржкрзНрж░ржпрж╝рзЛржЬржи ржирзЗржЗ
    onLoad: function() {
        // ржкрзНрж░рждрж┐ржЯрж┐ ржЧрзНрж░рзБржкрзЗрж░ ржЬржирзНржп ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо ржПржЦрж╛ржирзЗ рж╕рзЗржЯ ржХрж░рзБржи 
        // ржЖржкржирж┐ ржЪрж╛ржЗрж▓рзЗ ржПржЯрж┐ ржЦрж╛рж▓рж┐ рж░рж╛ржЦрждрзЗ ржкрж╛рж░рзЗржи ржмрж╛ ржПржХржЯрж┐ ржирж╛ржо ржжрж┐рждрзЗ ржкрж╛рж░рзЗржиред 
        // ржпржжрж┐ ржПржЯрж┐ ржЦрж╛рж▓рж┐ ржерж╛ржХрзЗ, рждржмрзЗ bot ржПржЯрж┐ ржкрзНрж░ржержоржмрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи рж╣ржУржпрж╝рж╛рж░ ржкрж░ ржирж┐ржЬрзЗржЗ ржПржХржЯрж┐ ржирж╛ржо рж╕рзЗржЯ ржХрж░рзЗ ржирзЗржмрзЗред
        global.config.GROUP_DEFAULT_NAME = global.config.GROUP_DEFAULT_NAME || {};
    },

    // ------------------------------------------------
    // Command Function (To set the default name and turn on/off)
    // ------------------------------------------------
    run: function ({ api, event, args, global }) {
        if (args.length === 0 || args[0].toLowerCase() === "help") {
            return api.sendMessage(
                "ржПржЗ ржХржорж╛ржирзНржбрзЗрж░ ржмрзНржпржмрж╣рж╛рж░:\n" +
                "1. `autorename set <Default Name>`: ржПржЗ ржЧрзНрж░рзБржкрзЗ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржлрж┐рж░рж┐ржпрж╝рзЗ ржЖржирж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо рж╕рзЗржЯ ржХрж░рзБржиред\n" +
                "2. `autorename off`: ржПржЗ ржЧрзНрж░рзБржкрзЗ ржЕржЯрзЛ-рж░рж┐ржирзЗржо ржмржирзНржз ржХрж░рзБржиред\n" +
                "3. `autorename show`: ржмрж░рзНрждржорж╛ржи ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо ржжрзЗржЦрзБржиред", 
                event.threadID, event.messageID
            );
        }

        let threadID = event.threadID;

        if (args[0].toLowerCase() === "set") {
            let newName = args.slice(1).join(" ").trim();
            if (!newName) {
                return api.sendMessage("тЪая╕П ржжрзЯрж╛ ржХрж░рзЗ ржПржХржЯрж┐ ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо ржжрж┐ржиред", threadID, event.messageID);
            }
            
            global.config.GROUP_DEFAULT_NAME[threadID] = newName;
            api.sendMessage(`тЬЕ ржПржЗ ржЧрзНрж░рзБржкрзЗрж░ ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ: "${newName}"ред ржПржЦржи ржХрзЗржЙ ржирж╛ржо ржкрж╛рж▓рзНржЯрж╛рж▓рзЗ ржПржЯрж┐ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржПржЗ ржирж╛ржорзЗ ржлрж┐рж░рзЗ ржпрж╛ржмрзЗред`, threadID, event.messageID);
        
        } else if (args[0].toLowerCase() === "off") {
            if (global.config.GROUP_DEFAULT_NAME[threadID]) {
                delete global.config.GROUP_DEFAULT_NAME[threadID];
                api.sendMessage("тЭМ ржПржЗ ржЧрзНрж░рзБржкрзЗ ржЕржЯрзЛ-рж░рж┐ржирзЗржо ржмржирзНржз ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред", threadID, event.messageID);
            } else {
                 api.sendMessage("тЪая╕П ржПржЗ ржЧрзНрж░рзБржкрзЗ ржЕржЯрзЛ-рж░рж┐ржирзЗржо ржЖржЧрзЗржЗ ржмржирзНржз ржЫрж┐рж▓ред", threadID, event.messageID);
            }
        
        } else if (args[0].toLowerCase() === "show") {
            let currentName = global.config.GROUP_DEFAULT_NAME[threadID] || "рж╕рзЗржЯ ржХрж░рж╛ рж╣ржпрж╝ржирж┐ред";
            api.sendMessage(`ржПржЗ ржЧрзНрж░рзБржкрзЗрж░ ржмрж░рзНрждржорж╛ржи ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо: "${currentName}"ред`, threadID, event.messageID);
        }
    },

    // ------------------------------------------------
    // Event Handler (The core logic)
    // ------------------------------------------------
    Event: async function ({ api, event, global }) {
        // рж╢рзБржзрзБржорж╛рждрзНрж░ ржпржЦржи ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо ржкрж░рж┐ржмрж░рзНрждрж┐ржд рж╣ржпрж╝ рждржЦржи ржХрж╛ржЬ ржХрж░ржмрзЗ
        if (event.logMessageType === "log:threadName") {
            let threadID = event.threadID;
            let currentName = event.logMessageData.name;
            let defaultName = global.config.GROUP_DEFAULT_NAME[threadID];
            
            // ржпржжрж┐ ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо рж╕рзЗржЯ ржХрж░рж╛ ржирж╛ ржерж╛ржХрзЗ
            if (!defaultName) {
                // ржпржжрж┐ ржПржЯрж┐ ржкрзНрж░ржержоржмрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи рж╣ржпрж╝, рждрж╛рж╣рж▓рзЗ ржПржЯрж┐ржХрзЗ ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржЯ ржХрж░рзБржи
                global.config.GROUP_DEFAULT_NAME[threadID] = currentName;
                api.sendMessage(`ЁЯдЦ ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо ржкрзНрж░ржержоржмрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯрзЗржЫрзЗред ржПржЦржи ржерзЗржХрзЗ ржбрж┐ржлрж▓рзНржЯ ржирж╛ржо рж╣рж┐рж╕рзЗржмрзЗ "${currentName}" рж╕рзЗржЯ ржХрж░рж╛ рж╣рж▓рзЛред`, threadID);
                return; 
            }

            // ржпржжрж┐ ржмрж░рзНрждржорж╛ржи ржирж╛ржо ржбрж┐ржлрж▓рзНржЯ ржирж╛ржорзЗрж░ рж╕рж╛ржерзЗ ржирж╛ ржорзЗрж▓рзЗ, рждрж╛рж╣рж▓рзЗ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗ ржжрзЗржмрзЗ
            if (currentName !== defaultName) {
                try {
                    // 1 рж╕рзЗржХрзЗржирзНржб ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзЗ ржмржЯ ржЧрзНрж░рзБржкрзЗрж░ ржирж╛ржо ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗ ржжрзЗржмрзЗ
                    await new Promise(resolve => setTimeout(resolve, 1000)); 
                    await api.changeThreadName(defaultName, threadID);
                    
                    api.sendMessage(
                        `тЪая╕П ${event.logMessageData.newName} ржЧрзНрж░рзБржкржЯрж┐рж░ ржирж╛ржо ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗржЫрж┐рж▓рзЛред рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ ржирж╛ржо "${defaultName}"-ржП ржлрж┐рж░рж┐ржпрж╝рзЗ ржЖржирж╛ рж╣рж▓рзЛред`, 
                        threadID
                    );
                } catch (e) {
                    console.error("Autorename Failed:", e);
                    api.sendMessage(`тЭМ ржЕржЯрзЛ-рж░рж┐ржирзЗржо ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗржЫрзЗред рждрзНрж░рзБржЯрж┐: ${e.message}`, threadID);
                }
            }
        }
    }
};
